name: Enhanced Download and Upload to Telegram

on:
  workflow_dispatch:
    inputs:
      download_url:
        description: 'Download URL (YouTube, Google Drive, Mega, Dropbox, OneDrive, Direct Link, etc.)'
        required: true
      download_type:
        description: 'Type of download (video, cloud, direct)'
        required: true
        type: choice
        options:
          - video
          - cloud
          - direct

jobs:
  download-and-upload:
    runs-on: ubuntu-latest
    environment: Telegram  # Reference the Telegram environment
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up environment
        run: |
          sudo apt-get update
          sudo apt-get install -y curl python3-pip ffmpeg megatools zip

      - name: Install Python dependencies
        run: |
          pip install telethon yt-dlp gdown requests

      - name: Install rclone
        run: |
          curl https://rclone.org/install.sh | sudo bash

      - name: Configure rclone
        run: |
          mkdir -p ~/.config/rclone
          echo "${{ secrets.RCLONE_CONFIG }}" > ~/.config/rclone/rclone.conf

      - name: Debug Telegram credentials
        run: |
          echo "TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}"
          echo "TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}"

      - name: Notify download started
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
          -d text="ðŸ“¥ Download started: ${{ github.event.inputs.download_url }}"

      - name: Download file
        run: |
          echo "Downloading: ${{ github.event.inputs.download_url }}"
          if [[ "${{ github.event.inputs.download_type }}" == "video" ]]; then
            # Use yt-dlp for videos
            yt-dlp -o "%(title)s.%(ext)s" "${{ github.event.inputs.download_url }}"
            FILE="$(yt-dlp --get-filename -o "%(title)s.%(ext)s" "${{ github.event.inputs.download_url }}")"
          elif [[ "${{ github.event.inputs.download_type }}" == "cloud" ]]; then
            # Handle cloud links
            if [[ "${{ github.event.inputs.download_url }}" == *"drive.google.com"* ]]; then
              gdown -O "$(basename "${{ github.event.inputs.download_url }}")" "${{ github.event.inputs.download_url }}"
              FILE="$(basename "${{ github.event.inputs.download_url }}")"
            elif [[ "${{ github.event.inputs.download_url }}" == *"mega.nz"* ]]; then
              megadl "${{ github.event.inputs.download_url }}" --username="${{ secrets.MEGA_EMAIL }}" --password="${{ secrets.MEGA_PASSWORD }}" --path="$(basename "${{ github.event.inputs.download_url }}")"
              FILE="$(basename "${{ github.event.inputs.download_url }}")"
            elif [[ "${{ github.event.inputs.download_url }}" == *"dropbox.com"* ]]; then
              curl -o "$(basename "${{ github.event.inputs.download_url }}")" "$(echo "${{ github.event.inputs.download_url }}" | sed 's/dl=0/dl=1/')"
              FILE="$(basename "${{ github.event.inputs.download_url }}")"
            elif [[ "${{ github.event.inputs.download_url }}" == *"onedrive.live.com"* || "${{ github.event.inputs.download_url }}" == *"1drv.ms"* ]]; then
              rclone copyurl "${{ github.event.inputs.download_url }}" ./ --config ~/.config/rclone/rclone.conf
              FILE="$(ls -t | head -1)"
            else
              echo "Unsupported cloud link."
              exit 1
            fi
          else
            # Handle direct links
            curl -o "$(basename "${{ github.event.inputs.download_url }}")" "${{ github.event.inputs.download_url }}"
            FILE="$(basename "${{ github.event.inputs.download_url }}")"
          fi

          # Notify download finished
          FILE_SIZE=$(stat -c%s "$FILE")
          MD5_CHECKSUM=$(md5sum "$FILE" | awk '{ print $1 }')
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
          -d text="âœ… Download finished: $FILE\nSize: $((FILE_SIZE / 1024 / 1024)) MB\nMD5: $MD5_CHECKSUM"

      - name: Notify upload started
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
          -d text="ðŸ“¤ Uploading to Telegram: $FILE"

      - name: Upload file to Telegram
        run: |
          python3 upload_to_telegram.py "$FILE" "${{ secrets.TELEGRAM_BOT_TOKEN }}" "${{ secrets.TELEGRAM_CHAT_ID }}"

      - name: Notify upload finished
        run: |
          FILE_SIZE=$(stat -c%s "$FILE")
          MD5_CHECKSUM=$(md5sum "$FILE" | awk '{ print $1 }')
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
          -d text="âœ… Upload finished: $FILE\nSize: $((FILE_SIZE / 1024 / 1024)) MB\nMD5: $MD5_CHECKSUM"

      - name: Clean up
        run: |
          rm -rf "$FILE"
