name: Enhanced Download and Upload to Telegram

on:
  workflow_dispatch:
    inputs:
      download_urls:
        description: 'Comma-separated list of download URLs (YouTube, Google Drive, Mega, Dropbox, OneDrive, Direct Link, etc.)'
        required: true
      is_video:
        description: 'Is this a video? (Toggle between "yes" and "no")'
        required: true
        default: 'no'
        type: choice
        options:
          - yes
          - no

jobs:
  download-and-upload:
    runs-on: ubuntu-latest
    env:
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up environment
        run: |
          sudo apt-get update
          sudo apt-get install -y curl python3-pip ffmpeg megatools zip imagemagick

      - name: Install yt-dlp, gdown, and rclone
        run: |
          sudo pip install yt-dlp gdown
          curl https://rclone.org/install.sh | sudo bash

      - name: Configure rclone
        run: |
          mkdir -p ~/.config/rclone
          echo "${{ secrets.RCLONE_CONFIG }}" > ~/.config/rclone/rclone.conf

      - name: Notify start
        run: |
          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
          -d chat_id="$TELEGRAM_CHAT_ID" \
          -d text="ðŸš€ Workflow started! Downloading files..."

      - name: Download files
        run: |
          IFS=',' read -r -a URLS <<< "${{ github.event.inputs.download_urls }}"
          for URL in "${URLS[@]}"; do
            echo "Downloading: $URL"

            if [[ "${{ github.event.inputs.is_video }}" == "yes" ]]; then
              # Use yt-dlp for videos (preserve original file name)
              yt-dlp "$URL"
            else
              # Handle as direct/cloud link
              if [[ "$URL" == *"drive.google.com"* ]]; then
                gdown "$URL"
              elif [[ "$URL" == *"mega.nz"* ]]; then
                megadl "$URL" --username="${{ secrets.MEGA_EMAIL }}" --password="${{ secrets.MEGA_PASSWORD }}"
              elif [[ "$URL" == *"dropbox.com"* ]]; then
                curl -O "$(echo "$URL" | sed 's/dl=0/dl=1/')"
              elif [[ "$URL" == *"onedrive.live.com"* || "$URL" == *"1drv.ms"* ]]; then
                rclone copyurl "$URL" ./ --config ~/.config/rclone/rclone.conf
              else
                curl -O "$URL"
              fi
            fi

            # Detect file type
            FILE=$(ls -t | head -1)  # Get the most recently downloaded file
            FILE_TYPE=$(file --mime-type -b "$FILE")
            echo "File type: $FILE_TYPE"

            # Convert video if needed
            if [[ "$FILE_TYPE" == *"video"* && "$FILE_TYPE" != *"mp4"* ]]; then
              ffmpeg -i "$FILE" -c:v libx264 -c:a aac "${FILE%.*}.mp4"
              FILE="${FILE%.*}.mp4"  # Update FILE variable to point to the converted file
            fi

            # Generate thumbnail for videos
            if [[ "$FILE_TYPE" == *"video"* ]]; then
              ffmpeg -i "$FILE" -ss 00:00:01 -vframes 1 "${FILE%.*}_thumbnail.jpg"
            fi

            # Check file size
            FILE_SIZE=$(stat -c%s "$FILE")
            if [[ $FILE_SIZE -gt 2000000000 ]]; then
              curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
              -d chat_id="$TELEGRAM_CHAT_ID" \
              -d text="âŒ File is too large (>2 GB). Cannot upload to Telegram."
              continue
            fi

            # Upload file to Telegram
            curl -F chat_id="$TELEGRAM_CHAT_ID" \
            -F document=@"$FILE" \
            -F caption="File: $FILE" \
            https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendDocument

            # Upload thumbnail if available
            if [[ -f "${FILE%.*}_thumbnail.jpg" ]]; then
              curl -F chat_id="$TELEGRAM_CHAT_ID" \
              -F photo=@"${FILE%.*}_thumbnail.jpg" \
              https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendPhoto
              rm "${FILE%.*}_thumbnail.jpg"
            fi

            # Clean up
            rm -rf "$FILE"
          done

      - name: Notify completion
        run: |
          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
          -d chat_id="$TELEGRAM_CHAT_ID" \
          -d text="âœ… Workflow completed! All files processed."
